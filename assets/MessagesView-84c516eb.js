import{g as y,N as k,_ as x}from"./android-chrome-B-192x192-4517b689.js";import{_ as j,r as _,o as i,c,a,b as d,w as f,h as D,F as g,e as m,f as u,d as L,v as X,t as l,k as E,n as M,p as b,g as A}from"./index-b58b0c5a.js";const N={props:["user"],data(){return{isLoading:!0,sendSharp:y,isDragging:!1,startPosition:0,currentTranslateX:0,translateX:0,minTranslateX:0,maxTranslateX:0,msj:"",usersFollowed:[],getChat:[],allChats:[],emisorChat:"",receptorChat:"",userLogged:this.$store.state.user,show:!1,showMsj:!0,userReceived:null}},methods:{truncatedText(s){if(s)return s.slice(0,12)+(s.length>12?"...":"")},startChat(){const s=this.$store.state.chat_user;s&&(this.receptorChat=s,this.show=!0,this.newChat(this.receptorChat))},calculateTimeAgo(s){const t=new Date,o=new Date(s),h=t-o,r=Math.floor(h/(1e3*60));return r<60?`${r} min`:r<1440?`${Math.floor(r/60)} h`:`${Math.floor(r/1440)} d`},getThisChat(s,t){s===this.userLogged?this.newChat(t):this.newChat(s)},newChat(s){this.receptorChat=s,this.showMsj=!1;const t=this.$store.state.user;fetch(`http://localhost:5000/message/${t}/${s}`).then(o=>{if(o.ok)return o.json();throw new Error("Error en la solicitud.")}).then(o=>{this.getChat=o.chats,this.emisorChat=o.emisor,this.receptorChat=o.receptor,this.show=!0}).catch(o=>{console.error("Error: ",o)})},handleKeyDown(s){s.key==="Enter"&&(s.preventDefault(),this.sendMsj())},sendMsj(){if(this.msj&&/\S/.test(this.msj)){const s=this.emisorChat,t=this.receptorChat;let o={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contenido:this.msj})};fetch(`http://localhost:5000/message/${s}/${t}`,o).then(h=>{if(h.ok)return h.json();throw new Error("Error en la solicitud.")}).then(h=>{this.msj="",this.getChat=h,this.newChat(t),this.getAllChats()}).catch(h=>{console.error("Error: ",err)})}},resizeTextarea(){if(this.$refs.textarea){const s=this.$refs.textarea;s.style.height="auto",s.style.height=s.scrollHeight+"px"}},startDrag(s){this.isDragging=!0,this.startPosition=s.touches[0].clientX,this.currentTranslateX=this.translateX},drag(s){if(this.isDragging){const o=s.touches[0].clientX-this.startPosition;this.translateX=Math.min(Math.max(this.minTranslateX,this.currentTranslateX+o),this.maxTranslateX)}},stopDrag(){this.isDragging=!1},calculateLimits(){if(this.$refs.carousel){const s=this.$el.clientWidth,t=this.$refs.carousel.scrollWidth;this.maxTranslateX=0,this.minTranslateX=Math.min(0,s-t)}},getUsuersFollowed(){const s=this.$store.state.user;fetch(`http://localhost:5000/follow/${s}`).then(t=>{if(t.ok)return t.json();throw new Error("Error en la solicitud.")}).then(t=>{this.usersFollowed=t.user.sort((o,h)=>{const r=new Date(o.fecha_seguimiento);return new Date(h.fecha_seguimiento)-r}),this.usersFollowed.forEach(o=>{o.img_perfil="data:image/jpeg;base64,"+o.img_perfil})}).catch(t=>{console.error("Error: ",t)})},getAllChats(){const s=this.userLogged;fetch(`http://localhost:5000/message/${s}`).then(t=>{if(t.ok)return t.json();throw new Error("Error en la solicitud.")}).then(t=>{this.allChats=t.sort((o,h)=>{const r=new Date(o.latest_message_date);return new Date(h.latest_message_date)-r}),this.allChats.forEach(o=>{o.img_perfil="data:image/jpeg;base64,"+o.img_perfil}),this.isLoading=!1}).catch(t=>{console.error("Error: ",t)})}},mounted(){this.getUsuersFollowed(),this.getAllChats(),this.startChat(),this.$nextTick(()=>{this.calculateLimits()}),window.addEventListener("resize",this.calculateLimits)},beforeUnmount(){this.$store.dispatch("cleanChatUser"),window.removeEventListener("resize",this.calculateLimits)},components:{Nav:k}},w=s=>(b("data-v-32168114"),s=s(),A(),s),S={class:"wrapper"},F={class:"container"},z={class:"logo"},B=w(()=>a("img",{src:x,alt:"imagen logo"},null,-1)),V={key:0,class:"loader"},U={key:1,class:"main"},I={class:"container-msj"},K=["onClick"],P=["src"],W={class:"name"},H={key:0,class:"newChat"},O=w(()=>a("p",null,"No hay conversaciones recientes.",-1)),J=[O],R={class:"containerMessages"},q={class:"containerChat"},G=["onClick"],Q={class:"img-user"},Y=["src"],Z={class:"info-user"},$={class:"name"},ee={key:0},se={key:1},te={key:2},re={key:3},oe={class:"last-msj"},ne={key:0},ae={key:1},ie={key:0,class:"containerMsj"},ce={class:"newMsj"};function he(s,t,o,h,r,n){const C=_("Nav"),p=_("router-link"),v=_("ion-icon");return i(),c("div",S,[a("div",F,[d(C),a("div",z,[d(p,{to:{name:"home"}},{default:f(()=>[B]),_:1})]),r.isLoading?(i(),c("div",V)):(i(),c("main",U,[a("div",I,[a("div",{class:"containerUsers",onTouchstart:t[0]||(t[0]=(...e)=>n.startDrag&&n.startDrag(...e)),onTouchmove:t[1]||(t[1]=(...e)=>n.drag&&n.drag(...e)),onTouchend:t[2]||(t[2]=(...e)=>n.stopDrag&&n.stopDrag(...e))},[a("div",{class:"box users",ref:"carousel",style:D({transform:"translateX("+r.translateX+"px)"})},[(i(!0),c(g,null,m(r.usersFollowed,e=>(i(),c("div",{class:"user",key:e.id,onClick:T=>n.newChat(e.followed_user)},[a("img",{src:e.img_perfil,alt:"imagen perfil"},null,8,P),a("span",W,"@"+l(e.followed_user),1)],8,K))),128))],4)],32),r.allChats==0&&r.showMsj?(i(),c("div",H,J)):u("",!0),a("div",R,[a("div",q,[(i(!0),c(g,null,m(r.allChats,e=>(i(),c("div",{class:"box chats",key:e.id},[a("div",{class:"chat",onClick:T=>n.getThisChat(e.recipient_user.user,e.sender_user.user)},[a("div",Q,[a("img",{src:e.img_perfil,alt:"imagen perfil"},null,8,Y)]),a("div",Z,[a("div",$,[e.sender_user.user===r.userLogged&&e.recipient_user.nombre!=="-"?(i(),c("span",ee,l(n.truncatedText(e.recipient_user.nombre)),1)):u("",!0),e.recipient_user.user===r.userLogged&&e.sender_user.nombre!=="-"?(i(),c("span",se,l(n.truncatedText(e.sender_user.nombre)),1)):u("",!0),e.sender_user.user===r.userLogged?(i(),c("span",te,"@"+l(n.truncatedText(e.recipient_user.user)),1)):u("",!0),e.recipient_user.user===r.userLogged?(i(),c("span",re,"@"+l(n.truncatedText(e.sender_user.user)),1)):u("",!0),a("span",null,l(n.calculateTimeAgo(e.latest_message_date)),1)]),a("div",oe,[e.sender_user.user===r.userLogged?(i(),c("p",ne,"TÃº: "+l(n.truncatedText(e.latest_message_content)),1)):u("",!0),e.recipient_user.user===r.userLogged?(i(),c("p",ae,l(n.truncatedText(e.latest_message_content)),1)):u("",!0)])])],8,G)]))),128))]),r.show?(i(),c("div",ie,[d(p,{to:{name:"user-profile",params:{user:r.receptorChat}},class:"h-chat"},{default:f(()=>[E(l(r.receptorChat),1)]),_:1},8,["to"]),(i(!0),c(g,null,m(r.getChat,e=>(i(),c("div",{class:"box msj",key:e.id},[a("div",{class:M(["msj",{emit:e.sender_user===r.userLogged,receive:e.sender_user!==r.userLogged}])},[a("p",null,l(e.contenido),1)],2)]))),128)),a("div",ce,[L(a("textarea",{rows:"1",ref:"textarea",name:"send",id:"send","onUpdate:modelValue":t[3]||(t[3]=e=>r.msj=e),onInput:t[4]||(t[4]=(...e)=>n.resizeTextarea&&n.resizeTextarea(...e)),placeholder:"Hola..",onKeydown:t[5]||(t[5]=(...e)=>n.handleKeyDown&&n.handleKeyDown(...e))},null,544),[[X,r.msj]]),d(v,{src:r.sendSharp,onClick:n.sendMsj},null,8,["src","onClick"])])])):u("",!0)])])]))])])}const de=j(N,[["render",he],["__scopeId","data-v-32168114"]]);export{de as default};
